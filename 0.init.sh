#!/bin/sh
set -eu

need_root() {
  if [ "$(id -u)" != "0" ]; then
    echo "âŒ è¯·ç”¨ root è¿è¡Œï¼ˆæˆ– sudoï¼‰"
    exit 1
  fi
}

ask() {
  # $1 prompt, $2 default(optional)
  prompt="$1"
  def="${2:-}"
  if [ -n "$def" ]; then
    printf "%s [%s]: " "$prompt" "$def"
  else
    printf "%s: " "$prompt"
  fi
  read -r ans || true
  if [ -z "${ans:-}" ] && [ -n "$def" ]; then
    ans="$def"
  fi
  echo "$ans"
}

append_unique_line() {
  # $1 file, $2 exact line
  file="$1"
  line="$2"
  touch "$file"
  grep -Fqx "$line" "$file" 2>/dev/null || echo "$line" >> "$file"
}

replace_or_append_kv() {
  # $1 file, $2 key, $3 value  (key = value)
  file="$1"
  key="$2"
  val="$3"
  touch "$file"
  if grep -Eq "^[[:space:]]*${key}[[:space:]]*=" "$file"; then
    # ç”¨ sed åŽŸåœ°æ›¿æ¢
    sed -i "s#^[[:space:]]*${key}[[:space:]]*=.*#${key} = ${val}#g" "$file"
  else
    echo "${key} = ${val}" >> "$file"
  fi
}

print_step() {
  echo
  echo "========== $1 =========="
}

need_root

print_step "1) è®¾ç½® Hostname"
HOSTNAME="$(ask "è¯·è¾“å…¥ hostname" "Alice")"

# set hostname immediately
hostname "$HOSTNAME" || true

# persist
echo "$HOSTNAME" > /etc/hostname

# hosts: 127.0.0.1 hostname
append_unique_line /etc/hosts "127.0.0.1 $HOSTNAME"

echo "âœ… Hostname å·²è®¾ç½®ä¸º: $HOSTNAME"

print_step "2) å®‰è£…å¸¸ç”¨è½¯ä»¶"
apk add --no-cache ca-certificates vim curl wget iperf3 htop sing-box
echo "âœ… å¸¸ç”¨è½¯ä»¶å®‰è£…å®Œæˆ"

print_step "3) è®¾ç½® DNS å¹¶é”å®š /etc/resolv.conf"
DNS_INPUT="$(ask "è¯·è¾“å…¥ DNSï¼ˆé€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼Œå¦‚ 2606:4700:4700::1001,8.8.4.4ï¼‰" "2606:4700:4700::1001,8.8.4.4")"

# è§£æž DNS è¾“å…¥ï¼šé€—å·->ç©ºæ ¼ï¼Œç„¶åŽé€ä¸ªå–
DNS_LIST="$(echo "$DNS_INPUT" | tr ',' ' ' | tr -s ' ')"

# å†™ resolv.confï¼ˆè¦†ç›–å†™å…¥ï¼‰
{
  echo "# Generated by init script on $(date 2>/dev/null || echo unknown-date)"
  for ns in $DNS_LIST; do
    [ -n "$ns" ] && echo "nameserver $ns"
  done
} > /etc/resolv.conf

# å°è¯•é”å®šï¼ˆchattr éœ€è¦ e2fsprogsï¼›æŸäº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒï¼‰
if command -v chattr >/dev/null 2>&1; then
  if chattr +i /etc/resolv.conf 2>/dev/null; then
    echo "âœ… /etc/resolv.conf å·²å†™å…¥å¹¶ chattr +i é”å®š"
  else
    echo "âš ï¸ chattr å­˜åœ¨ä½†é”å®šå¤±è´¥ï¼ˆå¯èƒ½æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒ immutableï¼‰"
  fi
else
  echo "âš ï¸ æœªæ‰¾åˆ° chattrï¼ˆå¯é€‰å®‰è£…ï¼šapk add --no-cache e2fsprogsï¼‰"
  echo "   å·²å†™å…¥ /etc/resolv.confï¼Œä½†æœªé”å®š"
fi

print_step "4) è®¾ç½®æ—¶åŒº Asia/Hong_Kong"
ln -sf /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime
echo "Asia/Hong_Kong" > /etc/timezone
echo "âœ… æ—¶åŒºå·²è®¾ç½®ä¸º Asia/Hong_Kong"

print_step "5) æ€§èƒ½ä¼˜åŒ– sysctl"
SYSCTL_FILE="/etc/sysctl.conf"
touch "$SYSCTL_FILE"

# TCP æ‹¥å¡žæŽ§åˆ¶
replace_or_append_kv "$SYSCTL_FILE" "net.core.default_qdisc" "fq"
replace_or_append_kv "$SYSCTL_FILE" "net.ipv4.tcp_congestion_control" "bbr"

# å‡å°‘å†…å­˜åŽ‹åŠ›
replace_or_append_kv "$SYSCTL_FILE" "vm.swappiness" "10"
replace_or_append_kv "$SYSCTL_FILE" "vm.vfs_cache_pressure" "200"

# socket buffer
replace_or_append_kv "$SYSCTL_FILE" "net.core.rmem_max" "16777216"
replace_or_append_kv "$SYSCTL_FILE" "net.core.wmem_max" "16777216"
# è¿™ä¸¤æ¡æ˜¯ä¸‰å…ƒç»„ï¼ŒæŒ‰ä½ ç»™çš„å€¼å†™æ•´è¡Œï¼ˆé¿å… kv æ›¿æ¢è¯¯ä¼¤ï¼‰
if grep -Eq "^[[:space:]]*net\.ipv4\.tcp_rmem[[:space:]]*=" "$SYSCTL_FILE"; then
  sed -i "s#^[[:space:]]*net\.ipv4\.tcp_rmem[[:space:]]*=.*#net.ipv4.tcp_rmem = 4096 87380 16777216#g" "$SYSCTL_FILE"
else
  echo "net.ipv4.tcp_rmem = 4096 87380 16777216" >> "$SYSCTL_FILE"
fi
if grep -Eq "^[[:space:]]*net\.ipv4\.tcp_wmem[[:space:]]*=" "$SYSCTL_FILE"; then
  sed -i "s#^[[:space:]]*net\.ipv4\.tcp_wmem[[:space:]]*=.*#net.ipv4.tcp_wmem = 4096 65536 16777216#g" "$SYSCTL_FILE"
else
  echo "net.ipv4.tcp_wmem = 4096 65536 16777216" >> "$SYSCTL_FILE"
fi

# TIME_WAIT å›žæ”¶
replace_or_append_kv "$SYSCTL_FILE" "net.ipv4.tcp_fin_timeout" "15"
replace_or_append_kv "$SYSCTL_FILE" "net.ipv4.tcp_tw_reuse" "1"

# åº”ç”¨
sysctl -p || true
echo "âœ… sysctl å·²å†™å…¥å¹¶å°è¯•åº”ç”¨ï¼ˆsysctl -pï¼‰"

print_step "6) ç”¨ OpenSSH æ›¿æ¢ BusyBox SSH"
apk update
apk add --no-cache openssh openssh-server

mkdir -p /etc/ssh

# ç”Ÿæˆ host keysï¼ˆåªè¦ç¼ºå°±ç”Ÿæˆï¼‰
ssh-keygen -A

# å¯ç”¨å¹¶å¯åŠ¨ sshdï¼ˆOpenRC / service å…¼å®¹ï¼‰
if command -v rc-update >/dev/null 2>&1; then
  rc-update add sshd default || true
fi

( rc-service sshd restart 2>/dev/null || rc-service sshd start 2>/dev/null || service sshd start 2>/dev/null || /etc/init.d/sshd start 2>/dev/null || true )

# å°è¯•åœæŽ‰ busybox sshd/dropbear
( pkill -f "busybox.*sshd" 2>/dev/null || true )
( pkill dropbear 2>/dev/null || true )

echo "âœ… OpenSSH å·²å¯ç”¨ï¼ˆå·²å°è¯•å¯åŠ¨ï¼‰ï¼ŒBusyBox SSH / dropbear å·²å°è¯•åœç”¨"

echo
echo "ðŸŽ‰ å…¨éƒ¨å®Œæˆã€‚å»ºè®®ä½ æ£€æŸ¥ï¼š"
echo " - hostname: $(hostname 2>/dev/null || echo "$HOSTNAME")"
echo " - resolv.conf: cat /etc/resolv.conf"
echo " - sshd: ps | grep sshd"
